<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile</title>
  <link rel="stylesheet" href="/static/css/reset.css">
  <link rel="stylesheet" href="/static/css/myProfile.css" />
  <link rel="stylesheet" href="/static/css/m-myprofile.css" />
  <script
          src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
          crossorigin="anonymous"
  ></script>
  <script src="/static/js/jQueryCheck.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gothic+A1&family=Nanum+Gothic&family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <script src="/js/console.js"></script>
</head>
<body>
<div class="wrap">
<!--  <div class="logo">-->
<!--    <img src="" alt="" />-->
<!--  </div>-->
  <h1 class="logoTitle">í”„ë¡œí•„ ìˆ˜ì •</h1>


    <div class="myProfile">
      <p class="title" id="titleImg">í”„ë¡œí•„ ì´ë¯¸ì§€</p>
      <div class="profileImg" id="pImg">
        <img src="" alt="" class="myImg" id="myImg" name="myImg" />
        <input type="file" name="file" id="updateImg"/>
        <input type="hidden" name="memberSeq" id="memberSeq" th:value="${myProfile.memberSeq}">
        <button class="updateBtn" id="deleteImg">ì‚­ì œ</button>
      </div>


    <div class="update" id="updateName">
      <p class="title">ì´ë¦„</p>
      <input
              type="text"
              th:value="${myProfile.memberName}"
              class="valName"
              name="myName"
              id="inputName"
              disabled
              value=""
      />
    </div>

    <div class="update" id="updateEmail">
      <p class="title">ì´ë©”ì¼</p>
      <input
              type="text"
              th:value="${myProfile.memberId}"
              class="valEmail"
              name="myEmail"
              disabled
      />
    </div>

      <div class="update" id="updatePhone">
        <p class="title">íœ´ëŒ€ì „í™”</p>
        <input
                type="text"
                th:value="${myProfile.memberPhone}"
                class="valPhone"
                name="myPhone"
                id="idPhone"
                disabled
        /><button class="toggle" id="PhoneToggle" type="button" >âœï¸</button>
      </div>
      <div class="hidden" id="hidn2" >
        <p>ë³€ê²½í•  íœ´ëŒ€ì „í™”</p>
        <p class="comment">
          íœ´ëŒ€í° ë²ˆí˜¸ëŠ” '-'ë¥¼ ì œì™¸í•˜ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>

        <form method="post" id="updatePhoneForm">
        <input
                type="text"
                value=""
                name="memberPhone"
                id="inputPhone"
                class="inputPhone"
                maxlength='12'
        />
        </form>

        <button type="button" id="sendSms">ì¸ì¦ë¬¸ì ë°œì†¡</button>
        <input
                type="text"
                value=""
                name="newPhone"
                id="phoneCheckVal"
                class="inputPhone"
                placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        />
        <div class="" style="clear: both"></div>
        <label for="Timer" id="timerLabel">ë‚¨ì€ ì‹œê°„:</label>
        <input id="Timer" type="text" class="inputPhone" value="" readonly/>
        <button type="button" id="phoneConfirm" >ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>
      </div>

      <th:block th:if="${myProfile.memberLogtype == 'normal'}">
    <div class="update" id="updatePw">
      <p class="title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</p>
      <button type="button" class="toggle" id="pwToggle">âœï¸</button>
    </div>
    <div class="hidden" id="hidn3">
      <p>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</p>
      <input
              type="password"
              name="oriPw"
              id="oriPw"
              class="inputPw"
      />
      <span id="oriCheck"></span>
      <p id="newComment1">ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸</p>
      <p id="comment" class="comment">
        ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”.
      </p>
      <input
              type="password"
              value=""
              name="newPw"
              id="newPw"
              class="inputPw"
      />
      <p id="newComment2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</p>
      <form method="post" id="updatePwForm">
      <input type="password" value="" id="checkPw" class="inputPw" name="memberPw" />
      <span id="pwStatus"></span>
      <button class="updateBtn" id="floatBtn">ìˆ˜ì •</button>
      </form>
    </div>
      </th:block>

</div>

<strong><a href="/member/loginIndex" id="goBack">ë’¤ë¡œê°€ê¸°</a></strong>
  <p class="cancel">
    ğŸ˜¨ íšŒì› íƒˆí‡´ë¥¼ ì›í•˜ì„¸ìš”? <a href="#" onclick="delClick();" onmouseenter="this.style.opacity =1;" onmouseleave="this.style.opacity=0.5;" style="opacity: 0.3;">íƒˆí‡´</a>
  </p>
</div>

<script>

  $(document).ready(function(){
      $("#PhoneToggle").click(function() {
          $("#hidn2").toggle();
      })
    $("#pwToggle").click(function() {
      $("#hidn3").toggle();
    })
    pwDisNone();

    //í”„ë¡œí•„ ì´ë¯¸ì§€ ì¶œë ¥ ajax
    $.ajax({
      url:"/member/selectProfileImg",
      success : function (){
      },error : function (){
      }
    }).done(function (rsp){
      $("#myImg").attr("src",rsp);
    })
  })

  function delClick(){
    if(confirm("íšŒì› íƒˆí‡´ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
      location.href = "/member/deleteMember";
      return true;
    } else {
      return false;
    }
  }

  //í”„ë¡œí•„ ì´ë¯¸ì§€ ìˆ˜ì •
  $("#myImg").click(function (){
    $("#updateImg").click();
  })

  $("#updateImg").on("change", readURL);

  function readURL(e) {
    if (e.target.files[0]) {
      if(e.target.files[0].size>(20*1024*1024)){
        alert("íŒŒì¼ ì‚¬ì´ì¦ˆëŠ” 10MB ì´ë‚´ë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.")
        return;
      }

      let ext = $("#updateImg").val().split('.').pop().toLowerCase();
      if($.inArray(ext, ['jpg','jpeg','png']) == -1){
        alert("í™•ì¥ìëŠ” jpg, png, jpegë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
        $("#updateImg").attr("src",e.target.files[0]);

      //FormDataëŠ” í¼ì„ ì‰½ê²Œ ë³´ë‚´ë„ë¡ ë„ì™€ì£¼ëŠ” ê°ì²´
      const formData = new FormData();
      formData.append("file",  e.target.files[0]);
      $.ajax({
        url:"/member/updateProfileImg",
        //processData : falseë¡œ ì„ ì–¸ ì‹œ formDataë¥¼ stringìœ¼ë¡œ ë³€í™˜í•˜ì§€ ì•ŠìŒ
        processData: false,
        //contentType : false ë¡œ ì„ ì–¸ ì‹œ content-type í—¤ë”ê°€ multipart/form-dataë¡œ ì „ì†¡ë˜ê²Œ í•¨
        contentType: false,
        data: formData,
        type:"post",
        success : function (){
        },error : function (){
        }
      }).done(function (){
      })
    }else{
      const formData = new FormData();
      let memberSeq =$("#memberSeq").val();
      formData.append("memberSeq", memberSeq);
      $.ajax({
        url:"/member/defaultProfileImg",
        type: 'post',
        data: formData,
        contentType: false,
        processData: false,
        success : function (){
        },error : function (){
        }
      }).done(function (rsp){
        $("#myImg").attr("src", "/static/img/defaultProfileImg.png");
        return;
      })
    }
    let reader = new FileReader();
    reader.onload = function(e) {
      if(reader.readyState === 2){
        $("#myImg").attr("src", reader.result);
      }
    }
    if(e.target.files[0]) {
      //í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      reader.readAsDataURL(e.target.files[0]);
    }
  }

  $("#deleteImg").click(function (){
    const formData = new FormData();
    let memberSeq =$("#memberSeq").val();
    formData.append("memberSeq", memberSeq);
    $.ajax({
      url:"/member/defaultProfileImg",
      type: 'post',
      data: formData,
      contentType: false,
      processData: false,
      success : function (){
      },error : function (){
      }
    }).done(function (){
      $("#myImg").attr("src", "/static/img/defaultProfileImg.png");
    })
  });

</script>

<script>
  // íœ´ëŒ€í°
  function phoneDisBlock(){
    $("#phoneCheckVal").css("display","inline-block");
    $("#phoneConfirm").css("display","block");
    $("#Timer").css("display","block");
    $("#timerLabel").css("display","block");
  }

  function phoneDisNone(){
    $("#phoneCheckVal").css("display","none");
    $("#phoneConfirm").css("display","none");
    $("#Timer").css("display","none");
    $("#timerLabel").css("display","none");
    $("#sendSms").css("display","none");
  }

  let phoneChkResult = false;
  const Timer = document.getElementById('Timer'); //ìŠ¤ì½”ì–´ ê¸°ë¡ì°½-ë¶„
  let time= 180000;
  let min=3;
  let sec=60;

  // ë¬¸ì ì¸ì¦
  let sendSms = $("#sendSms");
  let inputPhone = $("#inputPhone");
  const phoneRegex = /^010\d{4,4}?\d{4}$/;

  sendSms.on("click",function(){
    let inputPhoneVal = inputPhone.val();
    let phoneResult = phoneRegex.test(inputPhoneVal);

    if(inputPhone.val() == "") {
      alert("íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); // íœ´ëŒ€í° ë²ˆí˜¸ regexí•´ì•¼ë¨
      phoneChkResult = false;

    }else if(!phoneResult) {
      alert("íœ´ëŒ€í° ë²ˆí˜¸ ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      phoneChkResult = false;
      return false;

    }else if(phoneResult){
      sendSms.attr("disabled",false); // ë¬¸ì ë°œì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”(3ë¶„ê°„)
      inputPhone.attr("readonly",true);

      // íƒ€ì´ë¨¸
      alert("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

      sendSms.attr("disabled", true); // ë°œì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”

      Timer.value = min + ":" + '00';

      function TIMER() {
        PlAYTIME = setInterval(function () {
          time = time - 1000;
          min = time / (60 * 1000);

          if (sec > 0) {
            sec = sec - 1;
            Timer.value = Math.floor(min) + ':' + sec;

          }
          if (sec === 0) {
            sec = 60;
            Timer.value = Math.floor(min) + ':' + '00'
          }

        }, 1000);
      }
      TIMER();
      setTimeout(function(){
        alert("ì¸ì¦ì‹œê°„ì´ ê²½ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.");
        clearInterval(PlAYTIME);
        sendSms.attr("disabled",false); // 3ë¶„ì´ ì§€ë‚˜ë©´ ë²„íŠ¼ í™œì„±í™”
        phoneChkResult = false;
        phoneDisNone();
      },180000);// 1ë¶„ì´ ë˜ë©´ íƒ€ì´ë¨¸ë¥¼ ì‚­ì œ

      let param = {"to":inputPhoneVal};
      // ë¬¸ì ë°œì†¡
      $.ajax({
        url : "/sms/send",
        type : "post",
        contentType: 'application/json',
        data : JSON.stringify(param)
        ,success: function(){
          $("#phoneCheckVal").css("display","inline-block");
          phoneDisBlock();
        }
        ,error: function () {
          alert("ì¸ì¦ë¬¸ì ì „ì†¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
          $("#inputPhone").attr("readonly",false);
          $("#sendSms").attr("disabled",false);
        }
      }).done(function (rsp){
        // rsp : ë¬¸ì ë²ˆí˜¸
        let smsNum = rsp;
        $("#phoneConfirm").on("click",function (){
          if(smsNum == $("#phoneCheckVal").val()){
            alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
            alert("íœ´ëŒ€ì „í™” ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            phoneChkResult = true;
            $("#updatePhoneForm").attr("action","/member/updatePhone").submit();
          }else{
            alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸ í•´ì£¼ì„¸ìš”.");
            phoneChkResult = false;
          }
        })

      })

    }
  });
</script>

<script>
  // ë¹„ë°€ë²ˆí˜¸
  let newPw = $("#newPw");
  let pwStatus = $("#pwStatus");
  let checkPw = $("#checkPw");
  const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,14}$/;
  let resultCheck = false;

  function pwDisNone(){
    $("#newComment1").css("display","none");
    $("#comment").css("display","none");
    $("#newPw").css("display","none");
    $("#newComment2").css("display","none");
    $("#checkPw").css("display","none");
    $("#pwStatus").css("display","none");
    $("#floatBtn").css("display","none");
  }

  function pwDisBlock(){
    $("#newComment1").css("display","block");
    $("#comment").css("display","block");
    $("#newPw").css("display","block");
    $("#newComment2").css("display","block");
    $("#checkPw").css("display","block");
    $("#pwStatus").css("display","block");
    $("#floatBtn").css("display","block");
  }

  $("#oriPw").on("input",function () {
    let oriCheck = $("#oriPw").val();
    if ($("#oriPw").length == 0) {
      $("#oriCheck").html("");
    } else {
      $.ajax({
        url: "/member/myProfileCheckPw",
        data: {"memberPw": oriCheck},
        success: function () {
        }, error: function () {
        }
      }).done(function (rsp) {
        if (rsp == "true") {
          $("#oriCheck").html("ì¼ì¹˜í•©ë‹ˆë‹¤");
          resultCheck=true;
          pwDisBlock();
        } else {
          $("#oriCheck").html("ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          resultCheck=false;
          pwDisNone();
          $("#newPw").val("");
          $("#checkPw").val("");
          pwStatus.html("");
        }
      })
    }
  });


  newPw.on("blur",function(){
    let newPwVal = $("#newPw").val();
    let checkPwVal = $("#checkPw").val();
    let pwResult = pwRegex.test(newPwVal);

    if(newPwVal == ""){
      pwStatus.html("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      pwChkResult = false;
    }else if(!pwResult){
      pwStatus.html("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
      pwChkResult = false;
    }else{
      pwStatus.html("");
      if(newPwVal == "" && checkPwVal == ""){
        pwStatus.html("");
        pwChkResult = false;
      }else if(newPwVal != checkPwVal){
        pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        pwChkResult = false;
      }else if(newPwVal == checkPwVal){
        pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
        pwChkResult = true;
      }
    }
  });

  checkPw.on("blur",function(){
    let newPwVal = $("#newPw").val();
    let checkPwVal = $("#checkPw").val();
    let pwResult = pwRegex.test(newPwVal);

    if(checkPwVal == ""){
      pwStatus.html("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      pwChkResult = false;
    }else if(!pwResult){
      pwStatus.html("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
      pwChkResult = false;
    }else{
      pwStatus.html("");
      if(newPwVal == "" && checkPwVal == ""){
        pwStatus.html("");
        pwChkResult = false;
      }else if(newPwVal != checkPwVal){
        pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        pwChkResult = false;
      }else if(newPwVal == checkPwVal){
        pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
        pwChkResult = true;
      }
    }
  });

  $("#floatBtn").on("click",function (){
    let pwResult = pwRegex.test($("#newPw").val());
    if(resultCheck && pwResult && pwChkResult){
      alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      $("#updatePwForm").attr("action","/member/updatePw").submit();
    }else{
      alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”. ");
      return false;
    }
  })
</script>
</body>
</html>
