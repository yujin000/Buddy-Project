<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì…</title>
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/signup.css" />
    <link rel="stylesheet" href="/static/css/m-signup.css" />
    <script
      src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="/static/js/jQueryCheck.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gothic+A1&family=Nanum+Gothic&family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <script src="/static/js/console.js"></script>
  </head>
  <body>
    <div class="wrap">

      <h1 id="title">ğŸ˜€íšŒì›ê°€ì…</h1>
      <form method="post" id="form">
        <p id="titleName" class="titleName">ì´ë¦„</p>
          <th:block th:if="${userInfo.getMemberLogtype() != 'normal'}">
            <input type="text" name="memberName" class="inputName" th:value="${userInfo.getMemberName()}" readonly/>
            <input type="hidden" name="memberLogtype" th:value="${userInfo.getMemberLogtype()}" id="typeCheck" >
            <input type="hidden" name="memberPw" value="">
          </th:block>
          <th:block th:if="${userInfo.getMemberLogtype() == 'normal'}">
            <input type="text" name="memberName" class="inputName" id="inputName" maxlength='6'/>
            <span id="nameStatus"></span>
            <input type="hidden" name="memberLogtype" value="normal">
          </th:block>

        <p id="titleEmail" class="titleEmail">ì´ë©”ì¼</p>
          <th:block th:if="${userInfo.getMemberLogtype() != 'normal'}">
            <input type="text" name="memberId" class="inputEmail"  th:value="${userInfo.getMemberId()}" readonly/>
          </th:block>
          <th:block th:if="${userInfo.getMemberLogtype() == 'normal'}">
            <input type="text" name="memberId" class="inputEmail" id="inputId" maxlength='30' placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."/>
            <button type="button" id="emailSend">âœ‰ï¸ì´ë©”ì¼ë°œì†¡</button>
            <input type="test" id="emailCheckVal" placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
            <button type="button" id="emailConfirm" >âœ…ì¸ì¦</button>
            <!-- íƒ€ì´ë¨¸ ìƒì„± -->

            <div class="Timer">
            <label for="emailTimer" id="emailTimerLabel">ë‚¨ì€ ì‹œê°„:</label>
            <input id="emailTimer" type="text" value="" readonly/>
            </div>
            <br>
            <span id="idStatus"></span>
          </th:block>

        <th:block th:if="${userInfo.getMemberLogtype() == 'normal'}">
          <p id="titlePw" class="titlePw">ë¹„ë°€ë²ˆí˜¸</p>

          <input type="password" name="memberPw" id="inputPw" class="inputPw" maxlength='15' placeholder="ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”."/>
          <p id="titleTest" class="titleTest">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</p>
          <input type="password" name="testPw" id="testPw" class="testPw" maxlength='15' placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”."/>
          <span id="pwStatus"></span>
        </th:block>

        <p class="titlePhone" >íœ´ëŒ€ì „í™”</p>

        <th:block th:if="${userInfo.getMemberLogtype() == 'normal' || userInfo.getMemberLogtype() == 'kakao'}">
          <p class="comment">
            íœ´ëŒ€í° ë²ˆí˜¸ëŠ” '-'ë¥¼ ì œì™¸í•˜ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.
          </p>
          <input type="text" name="memberPhone" class="inputPhone" id="inputPhone" maxlength='12'/>
          <!-- íœ´ëŒ€í° ì¸ì¦ -->
          <button type="button" id="sendSms">ğŸ“ë¬¸ìë°œì†¡</button>
          <input type="test" id="phoneCheckVal" placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
          <button type="button" id="phoneConfirm" >âœ…ì¸ì¦</button>
          <!-- íƒ€ì´ë¨¸ ìƒì„± -->
          <div class="Timer">
          <label for="Timer" id="timerLabel">ë‚¨ì€ ì‹œê°„:</label>
          <input id="Timer" type="text" value="" readonly/>
          </div>

        </th:block>
        <th:block th:if="${userInfo.getMemberLogtype() == 'naver'}">
          <input type="text" name="memberPhone" class="inputPhone" th:value="${userInfo.getMemberPhone()}" readonly/>
        </th:block>

          <button id="signupBtn" class="signupBtn" >íšŒì›ê°€ì…</button>
        <th:block th:if="${userInfo.getMemberLogtype() != 'naver'}">
          <p class="goLogin">
            ì´ë¯¸ ê°€ì… í•˜ì…¨ë‚˜ìš”? <a href="/static"><strong>ë¡œê·¸ì¸</strong></a>
          </p>
        </th:block>
      </form>
    </div>

    <!-- ë²„íŠ¼ ìƒì„±/ì œê±° í•¨ìˆ˜-->
    <script>

      // ì´ë©”ì¼
      function emailDisBlock(){
        $(".Timer").css("display","block");
        $("#emailCheckVal").css("display","inline-block");
        $("#emailConfirm").css("display","inline");
        $("#emailTimer").css("display","inline-block");
        $("#emailTimerLabel").css("display","inline-block");
        $("#idStatus").css("display","none");
      }

      function emailDisNone(){
        $("#emailCheckVal").css("display","none");
        $("#emailConfirm").css("display","none");
        $("#emailTimer").css("display","none");
        $("#emailTimerLabel").css("display","none");
      }
      // íœ´ëŒ€í°
      function phoneDisBlock(){
        $("#phoneCheckVal").css("display","inline-block");
        $("#phoneConfirm").css("display","inline");
        $("#Timer").css("display","inline-block");
        $("#timerLabel").css("display","inline-block");
      }

      function phoneDisNone(){
        $("#phoneCheckVal").css("display","none");
        $("#phoneConfirm").css("display","none");
        $("#Timer").css("display","none");
        $("#timerLabel").css("display","none");
      }
    </script>
    <!-- íšŒì›ê°€ì… ìœ íš¨ì„± ê²€ì‚¬ -->
    <script>
      let nameChkResult = false;
      let idChkResult = false;
      let pwChkResult = false;

      // ì´ë¦„ ì²´í¬
      const nameRegex = /^[ê°€-í£]{1,5}$/;
      let nameStatus = $("#nameStatus");
      let inputName = $("#inputName");

      inputName.on("blur",function (){
        let inputNameVal = $("#inputName").val();
        let nameResult = nameRegex.test(inputNameVal);

        if(inputNameVal == ""){
          nameStatus.html("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          nameChkResult = false;
        }else if(!nameResult){
          nameStatus.html("ì´ë¦„ì€ 1~5ì í•œê¸€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          nameChkResult = false;
        }else{
          nameStatus.html("");
          nameChkResult = true;
        }
      });

      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      let inputPw = $("#inputPw");
      let pwStatus = $("#pwStatus");
      let testPw = $("#testPw");
      const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,14}$/;

      inputPw.on("blur",function(){
        let inputPwVal = $("#inputPw").val();
        let testPwVal = $("#testPw").val();
        let pwResult = pwRegex.test(inputPwVal);

        if(inputPwVal == ""){
          pwStatus.html("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          pwChkResult = false;
        }else if(!pwResult){
          pwStatus.html("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
          pwChkResult = false;
        }else{
          pwStatus.html("");
          if(inputPwVal == "" && testPwVal == ""){
            pwStatus.html("");
            pwChkResult = false;
          }else if(inputPwVal != testPwVal){
            pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            pwChkResult = false;
          }else if(inputPwVal == testPwVal){
            pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
            pwChkResult = true;
          }
        }
      });

      testPw.on("blur",function(){
        let inputPwVal = $("#inputPw").val();
        let testPwVal = $("#testPw").val();
        let pwResult = pwRegex.test(inputPwVal);

        if(testPwVal == ""){
          pwStatus.html("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          pwChkResult = false;
        }else if(!pwResult){
          pwStatus.html("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8~14ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
          pwChkResult = false;
        }else{
          pwStatus.html("");
          if(inputPwVal == "" && testPwVal == ""){
            pwStatus.html("");
            pwChkResult = false;
          }else if(inputPwVal != testPwVal){
            pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            pwChkResult = false;
          }else if(inputPwVal == testPwVal){
            pwStatus.html("íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
            pwChkResult = true;
          }
        }
      });
    </script>

    <!-- ì´ë©”ì¼ ì¸ì¦ regex -->
    <script>
      // ì•„ì´ë””(ì´ë©”ì¼) ì¤‘ë³µ ì²´í¬
      const idRegex = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
      let idStatus = $("#idStatus");
      let inputId = $("#inputId");
      let idDulCheck = false;


      // ì´ë©”ì¼ ë°œì†¡ / íƒ€ì´ë¨¸
      const emailTimer = document.getElementById('emailTimer');


      $("#emailSend").on("click",function (){
        let inputIdVal = $("#inputId").val();
        let idResult = idRegex.test(inputIdVal);

        if(inputIdVal == ""){
          idStatus.html("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          idDulCheck = false;
        }else if(!idResult) {
          idStatus.html("ì´ë©”ì¼ ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          idDulCheck = false;
        }else if(idResult){
          $.ajax({
            url : "/member/idCheck",
            data : {
              "id" : inputIdVal
            }
          }).done(function(rsp){
            if(rsp == 'false'){;
              idStatus.html("ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
              idDulCheck = true;

              if(idDulCheck){
                $("#inputId").attr("readonly",true);
                $("#emailSend").attr("disabled",true);

                emailSend();
                TIMER();

                setTimeout(function(){
                  alert("ì¸ì¦ì‹œê°„ì´ ê²½ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.");
                  clearInterval(PlAYTIME);
                  emailDisNone();
                  $("#inputId").attr("readonly",false);
                  $("#emailSend").attr("disabled",false); // 3ë¶„ì´ ì§€ë‚˜ë©´ ë²„íŠ¼ í™œì„±í™”
                  idChkResult = false;
                },180000);//3ë¶„ì´ ë˜ë©´ íƒ€ì´ë¨¸ë¥¼ ì‚­ì œ

              }else{
                alert("ì´ë©”ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.(ì¤‘ë³µëœ ì´ë©”ì¼ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
                idDulCheck = false;
              }

            }else if(rsp == 'true'){
              idStatus.html("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
              idDulCheck = false;
            }
          })
        }


      })

      // íƒ€ì´ë¨¸ í•¨ìˆ˜
      function TIMER() {
        let time= 180000;
        let min=3;
        let sec=60;

        emailTimer.value = min + ":" + '00';
        PlAYTIME = setInterval(function () {
          time = time - 1000;
          min = time / (60 * 1000);

          if (sec > 0) {
            sec = sec - 1;
            emailTimer.value = Math.floor(min) + ':' + sec;

          }
          if (sec === 0) {
            sec = 60;
            emailTimer.value = Math.floor(min) + ':' + '00'
          }

        }, 1000);
      }

      // ì´ë©”ì¼ ë‚œìˆ˜(6)ìƒì„± í•¨ìˆ˜
      let serialNo;

      function emailRan(){
        $.ajax({
          url: "/email/emailProve"
          ,type: "post"
          ,async: false
        }).done(function(rsp){
          serialNo = rsp;
        })
      }

      // ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜

      function emailSend() {
        emailRan();
        let subject = "[Buddy] íšŒì›ê°€ì… ì¸ì¦ë²ˆí˜¸ ì…ë‹ˆë‹¤.";
        let body = serialNo;
        let emailAdd = $("#inputId").val();
        let emailConfirmBtn = $("#emailConfirm");

        var params = {
          userId: emailAdd
          , subject: subject
          , body: body
        }

        $.ajax({
          url: "/email/sendEmail"
          , type: "POST"
          , accept: "application/json"
          , contentType: "application/json; charset=utf-8"
          , data: JSON.stringify(params)
          , dataType: "json"
          ,success: function(){
            emailDisBlock();
          }
          ,error: function () {
            alert("ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            $("#inputId").attr("readonly",false);
            $("#emailSend").attr("disabled",false);
          }
        }).done(function(){
          emailConfirmBtn.on("click",function(){
            if(serialNo == $("#emailCheckVal").val()){
              alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
              idChkResult = true;
              emailDisNone();
              $("#inputId").attr("readonly",true);
              $("#emailSend").attr("disabled",true);
            }else{
              alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
          })

        })
      }

    </script>
    <!-- ë¬¸ìì¸ì¦ ë¬¸ìì¸ì¦ regex -->
    <script>
      let phoneChkResult = false;
      const Timer = document.getElementById('Timer'); //ìŠ¤ì½”ì–´ ê¸°ë¡ì°½-ë¶„
      let time= 180000;
      let min=3;
      let sec=60;

      // ë¬¸ì ì¸ì¦
      let sendSms = $("#sendSms");
      let inputPhone = $("#inputPhone");
      const phoneRegex = /^010\d{4,4}?\d{4}$/;

      sendSms.on("click",function(){
        let inputPhoneVal = inputPhone.val();
        let phoneResult = phoneRegex.test(inputPhoneVal);

        if(inputPhone.val() == "") {
          alert("íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); // íœ´ëŒ€í° ë²ˆí˜¸ regexí•´ì•¼ë¨
          phoneChkResult = false;

        }else if(!phoneResult) {
          alert("íœ´ëŒ€í° ë²ˆí˜¸ ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          phoneChkResult = false;
          return false;

        }else if(phoneResult){
          sendSms.attr("disabled",false); // ë¬¸ì ë°œì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”(3ë¶„ê°„)
          inputPhone.attr("readonly",true);

          // íƒ€ì´ë¨¸
          alert("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

          sendSms.attr("disabled", true); // ë°œì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”

          Timer.value = min + ":" + '00';

          function TIMER() {
            PlAYTIME = setInterval(function () {
              time = time - 1000;
              min = time / (60 * 1000);

              if (sec > 0) {
                sec = sec - 1;
                Timer.value = Math.floor(min) + ':' + sec;

              }
              if (sec === 0) {
                sec = 60;
                Timer.value = Math.floor(min) + ':' + '00'
              }

            }, 1000);
          }
          TIMER();
          setTimeout(function(){
            alert("ì¸ì¦ì‹œê°„ì´ ê²½ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.");
            clearInterval(PlAYTIME);
            sendSms.attr("disabled",false); // 3ë¶„ì´ ì§€ë‚˜ë©´ ë²„íŠ¼ í™œì„±í™”
            phoneChkResult = false;
            phoneDisNone();
          },180000);// 1ë¶„ì´ ë˜ë©´ íƒ€ì´ë¨¸ë¥¼ ì‚­ì œ

          let param = {"to":inputPhoneVal};
          // ë¬¸ì ë°œì†¡
          $.ajax({
            url : "/sms/send",
            type : "post",
            contentType: 'application/json',
            data : JSON.stringify(param)
            ,success: function(){
            $("#phoneCheckVal").css("display","inline-block");
              phoneDisBlock();
          }
            ,error: function () {
            alert("ì¸ì¦ë¬¸ì ì „ì†¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            $("#inputPhone").attr("readonly",false);
            $("#sendSms").attr("disabled",false);
          }
          }).done(function (rsp){
            // rsp : ë¬¸ì ë²ˆí˜¸
            let smsNum = rsp;
            $("#phoneConfirm").on("click",function (){
              if(smsNum == $("#phoneCheckVal").val()){
                alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
                phoneChkResult = true;
                phoneDisNone();
              }else{
                alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸ í•´ì£¼ì„¸ìš”.");
                phoneChkResult = false;
              }
            })

          })

        }
      });
    </script>

    <!-- ì¹´ì¹´ì˜¤ ë„¤ì´ë²„ êµ¬ë¶„ -->
    <script>
      if($("#typeCheck").val() == "naver"){
        nameChkResult = true;
        idChkResult = true;
        pwChkResult = true;
        phoneChkResult = true;
      }else if($("#typeCheck").val() == "kakao"){
        nameChkResult = true;
        idChkResult = true;
        pwChkResult = true;
      }
    </script>
    <!-- íšŒì›ê°€ì… -->

    <script>
      let signupBtn = $("#signupBtn");

      signupBtn.on("click",function(){
        if(!nameChkResult || !idChkResult || !pwChkResult || !phoneChkResult){
          alert("ì´ë¦„, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, íœ´ëŒ€í°ì¸ì¦ì„ ëª¨ë‘ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
          return false;
        }else{
          alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          $("#form").attr("action","/member/signUp").submit();
        }
      })
    </script>

  </body>
</html>
