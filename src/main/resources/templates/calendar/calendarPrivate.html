<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset='utf-8'/>
  <script src='/static/fullcalendar/dist/index.global.js'></script>
  <script src="/static/fullcalendar/packages/core/locales-all.global.js"></script>
  <script
          src="https://code.jquery.com/jquery-3.6.2.js"
          integrity="sha256-pkn2CUZmheSeyssYw3vMp1+xyub4m+e+QK4sQskvuo4="
          crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ìº˜ë¦°ë” ìƒì„± í•¨ìˆ˜
      const calendarEl = document.getElementById('calendar');
      // div ê°€ calendar ì¸ ìº˜ë¦°ë” ê°ì²´ í˜¸ì¶œ
      const calendar = new FullCalendar.Calendar(calendarEl, {
        // ë§¨ ì²˜ìŒ ë„ìš°ëŠ” ìº˜ë¦°ë” í™”ë©´
        initialView: 'dayGridMonth',
        // í…Œë§ˆ : ë¶€íŠ¸ìŠ¤íŠ¸ë© ì ìš© / ë¯¸ì ìš©
        themeSystem: 'bootstrap5',
        // íˆ´ë°” ì„¤ì •
        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
        },
        // ì‚¬ìš©ì ë²„íŠ¼ ìƒì„±

        // ì–¸ì–´ ì„¤ì •
        locale: 'ko',
        weekday: 'short',
        day: 'short',
        // Allows a user to highlight multiple days or timeslots by clicking and dragging.
        selectable: true,
        // Whether to draw a â€œplaceholderâ€ event while the user is dragging.
        selectMirror: true,
        // Whether to automatically scoll the scroll-containers during event drag-and-drop and date selecting.
        dragScroll: true,
        // date ë¥¼ click í–ˆì„ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸(í•¸ë“¤ëŸ¬)
        navLinks: true,

        // allow "more" link when too many events ë„ˆë¬´ ë§ì€ ì´ë²¤íŠ¸ê°€ ìƒì„±ë ì‹œ moreë§í¬ë¥¼ ìƒì„±
        dayMaxEvents: true,
        //Whether or not to display a marker indicating the current time.
        nowIndicator: true,
        eventClick: function (arg) {

          const seq = arg.event.extendedProps.seq;
          const title = arg.event.title;
          const writer = arg.event.extendedProps.writer;
          const type = arg.event.extendedProps.type;
          const eventStart = arg.event._instance.range.start;
          const eventEnd = arg.event._instance.range.end;
          const memo = arg.event.extendedProps.memo;
          const location = arg.event.extendedProps.location;
          const color = arg.event._def.ui.backgroundColor;


          $("#form").css("display", "block");
          $(".btns").css("display", "block");
          $("#eventSeq").removeAttr("disabled");
          $("#eventWriter").removeAttr("disabled");
          //ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ìƒì„±
          $("#updateBtn").css("display", "block");
          $("#delBtn").css("display", "block");
          $("#submitBtn").css("display", "none");
          $("#closeBtn").css("display", "block");
          $("#eventWriter").attr("type", "text");

          function timeFormat(t) {
            return t.toISOString().substring(0, 16);
          }

          $("#eventType").val(type);
          $("#eventSeq").val(seq);
          $("#eventName").val(title.replace("[ê°œì¸]", ""));
          $("#eventWriter").val(writer);
          $("#eventMemo").val(memo);
          $("#eventLocation").val(location);
          $("#eventStart").attr("data-placeholder", timeFormat(eventStart));
          $("#eventStart").val(timeFormat(eventStart));
          $("#eventEnd").attr("data-placeholder", timeFormat(eventEnd));
          $("#eventEnd").val(timeFormat(eventEnd));
          $("#eventColor").val(color);
          $("#eventColor").css("background-color", color);

        },
        // date click event ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
        dateClick: function (arg) {

        },
        select: function (arg) {
          const start = arg.start
          const end = arg.end
          // date ë¥¼ timezone ì— ë§ê²Œ format
          // date ëŠ” loacale ì— ì˜í–¥ì„ ë°›ê¸° ë•Œë¬¸ì— kor ì‹œê°„ìœ¼ë¡œ ì„¤ì • í•´ì¤˜ì•¼ í•¨
          function timezoneFormat(d) {
            let offset = d.getTimezoneOffset() * 60000;
            // timezone Offset
            let dateOffset = new Date(d.getTime() - offset);
            // timezone Setting
            let iso = dateOffset.toISOString();
            // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            return iso.substring(0, 16);
          }

          // date ë¥¼ í˜•ì‹ì— ë§ê²Œ format í•˜ëŠ” í•¨ìˆ˜
          // ì›ì¸ : date typeì—ì„œ **ê¸°ê°„**ì„ ì„ íƒí• ë•Œ, í•˜ë£¨ê°€ ë” í•´ì ¸ì„œ ë‚˜ì˜´
          // í•´ê²° : ì‹œê°„ì— í•˜ë£¨ë§Œí¼ì— ì‹œê°„ì„ ë¹¼ì¤˜ì„œ ì¶œë ¥
          // input date type ì— value ë¥¼ ë„£ê¸° ìœ„í•´ì„œ ëŠ” IOS ë°©ì‹ìœ¼ë¡œ ë³€í™˜í•´ì•¼í•¨
          function dateFormat(d) {
            let offset = d.getTimezoneOffset() * 60000;
            const day = 8.64e+7; // í•˜ë£¨ë§Œí¼ì— ì‹œê°„ì„ **ë°€ë¦¬ì´ˆ**ë‹¨ìœ„ë¡œ ê³„ì‚°í•œ ê°’
            let dateOffset = new Date(d.getTime() - offset - day);
            let iso = dateOffset.toISOString();
            return iso.substring(0, 16);
          }


          let startFormat = timezoneFormat(start);
          let endFormat = dateFormat(end);

          $("#form").css("display", "block");
          $(".btns").css("display", "block");
          $("#updateBtn").css("display", "none");
          $("#delBtn").css("display", "none");
          $("#submitBtn").css("display", "block");
          $("#closeBtn").css("display", "block");

          $("#eventSeq").val("");
          $("#eventType").val("íŒ€");
          $("#eventName").val("");
          $("#eventWriter").val("");
          $("#eventWriter").attr("type", "hidden");
          $("#eventLocation").val("");
          $("#eventMemo").val("");
          const defaultColor = "#8621F7";
          $("#eventColor").val(defaultColor);
          $("#eventColor").css("background-color", "#8621F7");


          // month view ê°€ true ì¼ ë•Œë§Œ, date ê°’ì„ ì¡°ì •
          // day view ë‚˜ week view ì—ì„œëŠ” date ê°’ì„ ì¡°ì •í•˜ì§€ ì•ŠìŒ,
          // í•˜ë£¨ë§Œ ì„ íƒ í–ˆì„ë•Œë„ í•˜ë£¨ë§Œí¼ ì— ì‹œê°„ì´ ë¹ ì§€ê¸° ë•Œë¬¸
          let monthViewTrue = $('button[title="ì›”"]').attr("aria-pressed");
          // aria-pressed = true
          if (monthViewTrue === "true") {
            $("#eventStart").val(startFormat);
            $("#eventEnd").val(endFormat);
          }// aria-pressed = false
          else {
            $("#eventStart").val(startFormat);
            $("#eventEnd").val(timezoneFormat(end));
          }


        },

        unselect: function () {
          $("#form").css("display", "block");
          $("#updateBtn").css("display", "none");
          $("#delBtn").css("display", "none");
          $("#submitBtn").css("display", "block");

          $("#eventSeq").val("");
          $("#eventType").val("íŒ€");
          $("#eventName").val("");
          $("#eventWriter").val("");
          $("#eventWriter").attr("type", "hidden");
          $("#eventLocation").val("");
          $("#eventMemo").val("");
        },

        // events object ì´ë²¤íŠ¸ ê°ì²´ [ì¼ì •ì˜ ë°ì´í„°ê°€ ë‹´ê¸°ëŠ” ê³µê°„ json íƒ€ì…]
        events: function (info, successCallback) {

          $.ajax({
            url: "/calendar/selectPrivate",
            success: function (resp) {
              const events = [];
              let jsonParse = JSON.parse(resp);
              $.each(jsonParse, function (index, element) {
                events.push({
                  seq: element.eventSeq,
                  type: element.eventType,
                  title: "[" + element.eventType + "]" + element.eventName,
                  writer: element.eventWriter,
                  location: element.eventLocation,
                  memo: element.eventMemo,
                  start: element.eventStart,
                  end: element.eventEnd,
                  color: element.eventColor
                });

              })
              console.log(events);
              successCallback(events);
            }
            , error: function (request, status, error) {
              alert("code:" + request.status + error);
            }

          });

        },
        // other events here
        // document.ready ë™ì‘í…ŒìŠ¤íŠ¸


      })
      calendar.render();
      //ìº˜ë¦°ë” ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
    });




  </script>

  <link rel="stylesheet" href="/static/css/calendar.css">
  <title>ìº˜ë¦°ë” í…ŒìŠ¤íŠ¸</title>
</head>
<body>
<div class="header">
  <img src="/static/img/logo_m2.png" class="logoImg">
  <h1>ìº˜ë¦°ë”</h1>
  <div class="headerBtns">
    <button onclick="location.href='/calendar/goTeam'" class="calType" id="goTeam">
      íŒ€
    </button>
    <button onclick="location.href='/calendar/goPrivate'" class="calType checked" id="goPrivate">
      ê°œì¸
    </button>
    <button onclick="location.href='/calendar/moveCalendar'" class="calType" id="goAll">
      ì „ì²´
    </button>
    <button class="plusBtn" style="display: none">+</button>
  </div>
</div>
<div class="wrap" style="clear: both">
  <div class="modal">
    <div class="modalWrap">

      <div class="inputEvent">

        <button id="formToggle" type="button" class="formToggle">
          ì¼ì •ì¶”ê°€ +
        </button>


        <form action="/calendar/insertEvent" id="form" method="post">
          <select name="eventColor" id="eventColor" class="eventSelect" onchange="selectColor(value)" data-placeholder="ìƒ‰ìƒ">
            <option value="#8621F7" style="background: #8621F7" id="teamColor"></option>
            <option value="#2CADF5" id="blue" style="background: #2CADF5"></option>
            <option value="#FF5C00" id="red" style="background: #FF5C00"></option>
            <option value="#06C102" id="green" style="background:#06C102"></option>
            <option value="#545454"  id="black" style="background: #545454"></option>
          </select>
          <select name="eventType" id="eventType" class="eventSelect" >
            <option value="ê°œì¸">ê°œì¸ ìº˜ë¦°ë”</option>
          </select>
          <input type="hidden"  id="eventSeq" placeholder="seq" readonly disabled >
          <input type="text" name="eventName" id="eventName" placeholder="ì œëª©">
          <input type="hidden"  id="eventWriter" placeholder="ì‘ì„±ì" readonly disabled>
          <input type="datetime-local" name="eventStart" id="eventStart"  data-placeholder="ì‹œì‘ë‚ ì§œ"  required aria-required="true">
          <input type="datetime-local" name="eventEnd" id="eventEnd"  data-placeholder="ë§ˆê°ë‚ ì§œ" placeholder=""  required aria-required="true">
          <input type="text" name="eventLocation" id="eventLocation" placeholder="ì¥ì†Œ">
          <textarea name="eventMemo" id="eventMemo" cols="30" rows="10" placeholder="ë©”ëª¨"></textarea>
          <button type="submit" id="submitBtn" class="modalBtn">
            ì™„ë£Œ
          </button>
        </form>
        <div class="btns" style="display: none">
          <button type="submit" id="updateBtn" class="modalBtn" onclick="update()" style="display: none">ìˆ˜ì •</button>
          <button type="submit" id="delBtn" class="modalBtn" onclick="del()" style="display: none">ì‚­ì œ</button>
          <button type="button" id="closeBtn" class="modalBtn" onclick="window.location.reload()" >ì·¨ì†Œ</button>
        </div>
      </div>
      <button id="goMain"><a href="/member/loginIndex">ë©”ì¸ìœ¼ë¡œ</a></button>

    </div>
  </div>
  <div id='calendar'>


  </div>


</div>
<script>
  // ìœ íš¨ì„± ê²€ì‚¬
  const eventNameRegex = /^[0-9a-zA-Zã„±-í£]{0,20}$/;
  const eventLocationRegex = /^[0-9a-zA-Zã„±-í£]{0,20}$/;
  const eventMemoRegex = /^[0-9a-zA-Zã„±-í£\{\}\[\]\/?.,;:\|\)*~`!^\-_+\<\>@\#$%&\\\=\(\'\"  ]{0,500}$/m;

  $("#eventName").keyup(function (){
    let result = eventNameRegex.test(this.value);
    if (!result){
      alert("ì¼ì • ì œëª©ì€ 20ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
      this.value = "";
    }
  })

  $("#eventLocation").keyup(function (){
    let result = eventLocationRegex.test(this.value);
    if (!result){
      alert("ì¼ì • ì¥ì†ŒëŠ” 20ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
      this.value = "";
    }
  })

  $("#eventMemo").keyup(function (){
    let result = eventMemoRegex.test(this.value);
    if (!result){
      alert("ì¼ì • ë©”ëª¨ëŠ” 500ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
      this.value = "";
    }else {
      $(this).val().replace("<", "&lt;");
    }
  })



</script>
<script >



  $(document).ready(function (){

    // document.ready ë™ì‘í…ŒìŠ¤íŠ¸
    console.log("DOMReadyPrintTest");

    // ì¼ì •ì¶”ê°€ í† ê¸€ ë™ì‘
    $("#formToggle").click(function (){
      $("#form").toggle();
      $(".btns").toggle();
    });
    // ëª¨ë°”ì¼ë¡œ ì ‘ì†ì‹œ ìº˜ë¦°ë” ì¢…ë£Œ
    let windowWidth = window.innerWidth;
    if (windowWidth < 981) {
      alert("ìº˜ë¦°ë” ëŠ” ëª¨ë°”ì¼ í™”ë©´ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      window.close();
    }

  })

  // popUp ì‹œ viewport ì— ë”°ë¥¸ í™”ë©´ ìë™ì¡°ì •
  function winResize()
  {
    var Dwidth = parseInt(document.body.scrollWidth);
    var Dheight = parseInt(document.body.scrollHeight);
    var divEl = document.createElement("div");
    divEl.style.position = "absolute";
    divEl.style.left = "0px";
    divEl.style.top = "0px";
    divEl.style.width = "100%";
    divEl.style.height = "100%";

    document.body.appendChild(divEl);
    window.resizeBy(Dwidth-divEl.offsetWidth, Dheight-divEl.offsetHeight);
    document.body.removeChild(divEl);
  }


  // ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
  function select() {
    location.href ="/calendar/selectAll"
  }
  // ì¼ì •ì‚­ì œ ê¸°ëŠ¥
  function del() {
    const seq = $("#eventSeq").val();
    const type =  $("#eventType").val();
    const writer = document.querySelector("#eventWriter").value;
    if (type === "ê°œì¸"){
      const title = $("#eventName").val();
      if (confirm("<"+title+">"+"ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
        $("#eventWriter").attr("disabled",false);
        location.href ="/calendar/deleteEvent?eventSeq="+seq+"&eventWriter="+writer;
      }
    } else{
      const title = $("#eventName").val();
      if (confirm("<"+title+">"+"ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?,team")){
        $("#eventWriter").attr("disabled",false);
        location.href ="/calendar/teamEventDel?eventSeq="+seq+"&eventWriter="+writer;
      }
    }
  }
  // ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
  function update() {
    $("#eventWriter").attr("disabled",false);
    let seq = $("#eventSeq").val();
    let type =$("#eventType").val();
    let title =$("#eventName").val();
    let eventStart =$("#eventStart").val();
    let eventEnd =$("#eventEnd").val();
    let eventLocation =$("#eventLocation").val();
    let eventMemo =$("#eventMemo").val();
    let eventColor = document.querySelector("#eventColor").value;
    const writer = document.querySelector("#eventWriter").value;

    console.log(eventColor);

    // íƒ€ì…ì´ íŒ€ ì´ë¼ë©´
    if(type === "íŒ€"){
      if (confirm("<"+title+">"+"ì¼ì •ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
        location.href ="/calendar/teamEventUpd?eventSeq="+seq
                +"&eventType="+type
                +"&eventName="+title
                +"&eventStart="+eventStart
                +"&eventEnd="+eventEnd
                +"&eventLocation="+eventLocation
                +"&eventMemo="+eventMemo
                +"&eventColor="+encodeURIComponent(eventColor)
                +"&eventWriter="+writer;
      }

    }else {
      if (confirm("<"+title+">"+"ì¼ì •ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
        location.href ="/calendar/updateEvent?eventSeq="+seq
                +"&eventType="+type
                +"&eventName="+title
                +"&eventStart="+eventStart
                +"&eventEnd="+eventEnd
                +"&eventLocation="+eventLocation
                +"&eventMemo="+eventMemo
                +"&eventColor="+encodeURIComponent(eventColor)
                +"&eventWriter="+writer;
      }
    }

  }
  // evnetColor ê°’ì´ onchange ì‹œ value ì— ë”°ë¼ ë°°ê²½ìƒ‰ìƒ ë¶€ì—¬
  function selectColor(arg) {
    $("#eventColor").css("background",arg);
  }

</script>
</body>
</html>